<section class="agendamentos-page">
  <div class="page-header">
    <div>
      <h2>Agendamentos</h2>
      <p>Todos os comandos programados. Filtre por cliente ou termo.</p>
    </div>

    <button pButton type="button" label="Incluir agendamento" icon="pi pi-plus" (click)="showCreateForm()"></button>
  </div>

  <div class="agendamentos-filters">
    <div class="search-field">
      <i class="pi pi-search"></i>
      <input
        pInputText
        type="search"
        placeholder="Filtrar por cliente, nome ou comando"
        [value]="filterTerm()"
        (input)="filterTerm.set($any($event.target).value)"
      />
      <button
        pButton
        *ngIf="filterTerm()"
        type="button"
        icon="pi pi-times"
        class="p-button-text"
        (click)="filterTerm.set('')"
      ></button>
    </div>
  </div>

  <section class="agendamentos-list">
    @if (!loading()) {
      @if (filteredAgendamentos().length > 0) {
        <div class="agendamentos-grid">
          <article class="agendamento-card" *ngFor="let agendamento of filteredAgendamentos()">
            <header class="agendamento-card__header">
              <div>
                <span class="agendamento-card__label">Agendamento</span>
                <h3>{{ agendamento.schedule_name }}</h3>
                <p class="agendamento-card__subtle">{{ clientDisplayName(agendamento.client_id) }}</p>
              </div>
              <span class="status-chip" [class.active]="agendamento.is_active">
                {{ agendamento.is_active ? 'Ativo' : 'Inativo' }}
              </span>
            </header>

            <div class="agendamento-card__meta">
              <div>
                <span class="agendamento-card__label">Cron</span>
                <p>{{ agendamento.cron_expression }}</p>
              </div>
              <div>
                <span class="agendamento-card__label">Remote path</span>
                <p>{{ agendamento.remote_path || '—' }}</p>
              </div>
            </div>

            <div class="agendamento-card__command">
              <span class="agendamento-card__label">Comando</span>
              <code>{{ agendamento.rclone_command }}</code>
            </div>

            <footer class="agendamento-card__actions">
              <button
                pButton
                type="button"
                class="p-button-text"
                icon="pi pi-pencil"
                label="Editar"
                (click)="startEdit(agendamento)"
              ></button>
              <button
                pButton
                type="button"
                class="p-button-danger p-button-text"
                icon="pi pi-trash"
                label="Excluir"
                (click)="delete(agendamento)"
              ></button>
            </footer>
          </article>
        </div>
      } @else {
        <p class="empty-state">Nenhum agendamento encontrado com o filtro atual.</p>
      }
    } @else {
      <div class="loading-state">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
        <span>Carregando agendamentos...</span>
      </div>
    }
  </section>

  <p-dialog
    [visible]="isFormVisible()"
    (visibleChange)="isFormVisible.set($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [contentStyle]="{ padding: '1.5rem' }"
    (onHide)="closeForm()"
    [dismissableMask]="true"
    header="{{ formMode() === 'create' ? 'Criar agendamento' : 'Editar agendamento' }}"
  >
    <form [formGroup]="agendamentoForm" (ngSubmit)="submit()" class="agendamento-form">
      <div class="form-row">
        <label for="form_client_id">Cliente</label>
        <p-select
          id="form_client_id"
          formControlName="client_id"
          [options]="clientes()"
          optionLabel="nome_empresa"
          optionValue="client_id"
          placeholder="Selecione um cliente"
          [showClear]="true"
        ></p-select>
        <small class="field-error" *ngIf="agendamentoForm.controls.client_id.hasError('required')">
          Informe o cliente do agendamento.
        </small>
      </div>

      <div class="form-row">
        <label for="schedule_name">Nome do agendamento</label>
        <input
          pInputText
          id="schedule_name"
          formControlName="schedule_name"
          placeholder="Backup incremental diário"
        />
        <small class="field-error" *ngIf="agendamentoForm.controls.schedule_name.hasError('required')">
          Informe o nome do agendamento.
        </small>
      </div>

      <div class="form-row">
        <label for="rclone_command">Comando Rclone</label>
        <textarea
          pTextarea
          id="rclone_command"
          formControlName="rclone_command"
          rows="4"
          placeholder="rclone sync ..."
        ></textarea>
        <small class="field-error" *ngIf="agendamentoForm.controls.rclone_command.hasError('required')">
          Informe o comando que será executado.
        </small>
      </div>

      <div class="form-row">
        <label for="cron_expression">Cron expression</label>
        <input
          pInputText
          id="cron_expression"
          formControlName="cron_expression"
          placeholder="0 2 * * *"
        />
        <small class="field-error" *ngIf="agendamentoForm.controls.cron_expression.hasError('required')">
          Informe a expressão cron.
        </small>
      </div>

      <div class="form-row">
        <label for="remote_path">Remote path (opcional)</label>
        <input
          pInputText
          id="remote_path"
          formControlName="remote_path"
          placeholder="remote:path"
        />
      </div>

      <div class="form-row inline">
        <label for="is_active">Ativo</label>
        <p-toggleSwitch formControlName="is_active"></p-toggleSwitch>
      </div>

      <p-divider></p-divider>

      <div class="form-actions">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="closeForm()"></button>
        <button
          pButton
          type="submit"
          [label]="formMode() === 'create' ? 'Criar agendamento' : 'Salvar alterações'"
          [loading]="saving()"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
