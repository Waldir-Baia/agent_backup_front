<section class="servidores-page">
  <div class="page-header">
    <div>
      <h2>Servidores</h2>
      <p>Cadastre e acompanhe os servidores por cliente.</p>
    </div>
    <button pButton type="button" label="Adicionar novo" icon="pi pi-plus" (click)="showCreateForm()"></button>
  </div>

  <section class="servidores-table">
    <p-table
      *ngIf="!loading(); else loadingState"
      [value]="servidores()"
      [paginator]="false"
      class="servidores-table__grid"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Cliente</th>
          <th>Servidor</th>
          <th>Endereço IP</th>
          <th>Sistema operacional</th>
          <th>Status</th>
          <th>Uptime</th>
          <th class="actions-col"></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-servidor>
        <tr>
          <td>{{ clienteNome(servidor.cliente_id) }}</td>
          <td>{{ servidor.nome }}</td>
          <td>{{ servidor.endereco_ip }}</td>
          <td>{{ servidor.sistema_operacional || 'Não informado' }}</td>
          <td>
            <span
              class="status-pill"
              [class.status-pill--warning]="servidor.status === 2"
              [class.status-pill--danger]="servidor.status === 3"
              [class.status-pill--inactive]="servidor.status === 0"
            >
              {{ statusLabel(servidor.status) }}
            </span>
          </td>
          <td>{{ servidor.uptime_inicio ? (servidor.uptime_inicio | date: 'short') : '—' }}</td>
          <td class="actions-col">
            <button pButton type="button" icon="pi pi-pencil" class="p-button-text" (click)="startEdit(servidor)"></button>
            <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-text" (click)="delete(servidor)"></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
    <ng-template #loadingState>
      <div class="loading-state">
        <span>Carregando servidores...</span>
      </div>
    </ng-template>
  </section>

  <p-dialog
    [visible]="isFormVisible()"
    (visibleChange)="isFormVisible.set($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [contentStyle]="{ padding: '1.5rem' }"
    (onHide)="closeForm()"
    [dismissableMask]="true"
    header="{{ formMode() === 'create' ? 'Cadastrar servidor' : 'Editar servidor' }}"
  >
    <form [formGroup]="servidorForm" (ngSubmit)="submit()" class="servidor-form">
      <div class="form-row">
        <label for="cliente_id">Cliente</label>
        <p-select
          id="cliente_id"
          formControlName="cliente_id"
          [options]="clientes()"
          optionLabel="nome_empresa"
          optionValue="id"
          placeholder="Selecione um cliente"
          [showClear]="true"
        ></p-select>
        <small class="field-error" *ngIf="servidorForm.controls.cliente_id.hasError('required')">
          Selecione o cliente.
        </small>
      </div>

      <div class="form-row">
        <label for="nome">Nome do servidor</label>
        <input pInputText id="nome" formControlName="nome" placeholder="Ex: Fileserver 01" />
        <small class="field-error" *ngIf="servidorForm.controls.nome.hasError('required')">
          Informe o nome do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="endereco_ip">Endereço IP</label>
        <input pInputText id="endereco_ip" formControlName="endereco_ip" placeholder="Ex: 10.0.0.12" />
        <small class="field-error" *ngIf="servidorForm.controls.endereco_ip.hasError('required')">
          Informe o IP do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="sistema_operacional">Sistema operacional</label>
        <input
          pInputText
          id="sistema_operacional"
          formControlName="sistema_operacional"
          placeholder="Ex: Ubuntu 22.04"
        />
      </div>

      <div class="form-row">
        <label for="status">Status</label>
        <p-select
          id="status"
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o status"
        ></p-select>
      </div>

      <div class="form-row">
        <label for="uptime_inicio">Uptime (início)</label>
        <p-datepicker
          id="uptime_inicio"
          formControlName="uptime_inicio"
          [showIcon]="true"
          [showTime]="true"
          hourFormat="24"
          dateFormat="yy-mm-dd"
        ></p-datepicker>
      </div>

      <div class="form-row">
        <label for="mensagem_erro">Mensagem de erro</label>
        <textarea
          pTextarea
          id="mensagem_erro"
          formControlName="mensagem_erro"
          rows="2"
          class="textarea-control"
        ></textarea>
      </div>

      <p-divider></p-divider>

      <div class="form-actions">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="closeForm()"></button>
        <button
          pButton
          type="submit"
          [label]="formMode() === 'create' ? 'Cadastrar' : 'Salvar alterações'"
          [loading]="saving()"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
