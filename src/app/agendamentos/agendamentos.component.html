<section class="agendamentos-page">
  <div class="page-header">
    <div>
      <h2>Agendamentos</h2>
      <p>Configure os períodos de execução do Rclone para cada cliente.</p>
    </div>

    <mat-form-field appearance="outline" class="client-filter">
      <mat-label>Cliente</mat-label>
      <mat-select
        [value]="selectedClientId()"
        (valueChange)="onClientChange($event)"
        placeholder="Selecione um cliente"
      >
        <mat-option *ngFor="let cliente of clientes()" [value]="cliente.client_id">
          {{ cliente.nome_empresa }} ({{ cliente.client_id }})
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="page-content" [class.disabled]="!selectedClientId()">
    <mat-card class="agendamento-form-card">
      <mat-card-header>
        <mat-card-title>
          {{ formMode() === 'create' ? 'Criar agendamento' : 'Editar agendamento' }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="agendamentoForm" (ngSubmit)="submit()" class="agendamento-form">
          <mat-form-field appearance="outline">
            <mat-label>Nome do agendamento</mat-label>
            <input
              matInput
              formControlName="schedule_name"
              placeholder="Backup incremental diário"
            />
            <mat-error *ngIf="agendamentoForm.controls.schedule_name.hasError('required')">
              Informe o nome do agendamento.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Comando Rclone</mat-label>
            <textarea
              matInput
              formControlName="rclone_command"
              rows="4"
              placeholder="rclone sync ..."
            ></textarea>
            <mat-error *ngIf="agendamentoForm.controls.rclone_command.hasError('required')">
              Informe o comando que será executado.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cron expression</mat-label>
            <input
              matInput
              formControlName="cron_expression"
              placeholder="0 2 * * *"
            />
            <mat-error *ngIf="agendamentoForm.controls.cron_expression.hasError('required')">
              Informe a expressão cron.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Remote path (opcional)</mat-label>
            <input
              matInput
              formControlName="remote_path"
              placeholder="remote:path"
            />
          </mat-form-field>

          <mat-slide-toggle formControlName="is_active" color="primary">
            Ativo
          </mat-slide-toggle>

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="startCreate()">Cancelar</button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="!selectedClientId() || saving()"
            >
              {{ formMode() === 'create' ? 'Criar agendamento' : 'Salvar alterações' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <section class="agendamentos-table">
      <div class="table-wrapper" *ngIf="!loading(); else loadingState">
        <table mat-table [dataSource]="agendamentos()" class="mat-elevation-z1">
          <ng-container matColumnDef="schedule_name">
            <th mat-header-cell *matHeaderCellDef>Nome</th>
            <td mat-cell *matCellDef="let agendamento">{{ agendamento.schedule_name }}</td>
          </ng-container>

          <ng-container matColumnDef="rclone_command">
            <th mat-header-cell *matHeaderCellDef>Comando</th>
            <td mat-cell *matCellDef="let agendamento" class="command-cell">
              <code>{{ agendamento.rclone_command }}</code>
            </td>
          </ng-container>

          <ng-container matColumnDef="cron_expression">
            <th mat-header-cell *matHeaderCellDef>Cron</th>
            <td mat-cell *matCellDef="let agendamento">{{ agendamento.cron_expression }}</td>
          </ng-container>

          <ng-container matColumnDef="is_active">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let agendamento">
              <span class="status-chip" [class.active]="agendamento.is_active">
                {{ agendamento.is_active ? 'Ativo' : 'Inativo' }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let agendamento">
              <button mat-icon-button aria-label="Editar" (click)="startEdit(agendamento)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button aria-label="Excluir" color="warn" (click)="delete(agendamento)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
        <p class="empty-state" *ngIf="agendamentos().length === 0">
          Nenhum agendamento cadastrado para este cliente.
        </p>
      </div>

      <ng-template #loadingState>
        <div class="loading-state">
          <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
          <span>Carregando agendamentos...</span>
        </div>
      </ng-template>
    </section>
  </div>
</section>
