<section class="execucao-page">
  <div class="page-header">
    <div>
      <h2>Execução imediata</h2>
      <p>Dispare comandos pontuais para um agente específico.</p>
    </div>
  </div>

  <div class="page-content">
    <div class="execucao-form-card">
      <header>
        <h3>Enviar comando agora</h3>
      </header>
      <form [formGroup]="execucaoForm" (ngSubmit)="submit()" class="execucao-form">
        <div class="form-row">
          <label for="client_id">Cliente</label>
          <p-select
            id="client_id"
            formControlName="client_id"
            [options]="clientes()"
            optionLabel="nome_empresa"
            optionValue="client_id"
            placeholder="Selecione um cliente"
            [showClear]="true"
            (onChange)="handleClientSelection($event.value)"
          ></p-select>
          <small class="field-error" *ngIf="execucaoForm.controls.client_id.hasError('required')">
            Selecione o cliente.
          </small>
        </div>

        <div class="form-row">
          <label for="servidor_ip">Servidor</label>
          <p-select
            id="servidor_ip"
            formControlName="servidor_ip"
            placeholder="Selecione o servidor"
            [options]="servidores()"
            optionLabel="nome"
            optionValue="endereco_ip"
            [disabled]="loadingServidores() || servidores().length === 0"
          >
            <ng-template pTemplate="empty">
              <span *ngIf="loadingServidores()">Carregando servidores...</span>
              <span *ngIf="!loadingServidores() && servidores().length === 0">
                Nenhum servidor cadastrado para este cliente.
              </span>
            </ng-template>
          </p-select>
          <small class="field-error" *ngIf="execucaoForm.controls.servidor_ip.hasError('required')">
            Selecione o servidor.
          </small>
        </div>

        <div class="form-row">
          <label for="nome_tarefa">Nome da tarefa</label>
          <input pInputText id="nome_tarefa" formControlName="nome_tarefa" placeholder="Descrição rápida" />
          <small class="field-error" *ngIf="execucaoForm.controls.nome_tarefa.hasError('required')">
            Informe uma descrição.
          </small>
        </div>

        <div class="form-row">
          <label for="comando">Comando Rclone</label>
          <textarea pTextarea id="comando" formControlName="comando" rows="4" placeholder="rclone lsd …"></textarea>
          <small class="field-error" *ngIf="execucaoForm.controls.comando.hasError('required')">
            Informe o comando que será enviado.
          </small>
        </div>

        <p-divider></p-divider>

        <div class="form-actions">
          <button pButton type="submit" label="Executar agora" [loading]="submitting()"></button>
        </div>
      </form>
    </div>

    <div class="historico-card">
      <header>
        <h3>Últimas execuções</h3>
      </header>
      <div class="historico-content">
        <ng-container *ngIf="!loadingHistorico(); else loadingState">
          <p class="empty-state" *ngIf="historico().length === 0">
            Selecione um cliente para visualizar o histórico.
          </p>

          <p-table
            *ngIf="historico().length > 0"
            [value]="historico()"
            [paginator]="false"
            class="historico-table"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Data</th>
                <th>Tarefa</th>
                <th>Comando</th>
                <th>IP do servidor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.created_at | date: 'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ item.nome_tarefa }}</td>
                <td><code>{{ item.comando }}</code></td>
                <td>{{ item.ip_servidor || '—' }}</td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>

        <ng-template #loadingState>
          <div class="loading-state">
            <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
            <span>Carregando histórico...</span>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</section>
