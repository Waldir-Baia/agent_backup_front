<section class="servidores-page">
  <div class="page-header">
    <div>
      <h2>Servidores</h2>
      <p>Cadastre e acompanhe os servidores por cliente.</p>
    </div>
    <button pButton type="button" label="Adicionar novo" icon="pi pi-plus" (click)="showCreateForm()"></button>
  </div>

  <section class="servidores-list">
    <ng-container *ngIf="!loading(); else loadingState">
      <ng-container *ngIf="servidores().length > 0; else emptyState">
        <div class="servidores-grid">
          <article class="servidor-card" *ngFor="let servidor of servidores()">
            <header class="servidor-card__header">
              <div>
                <span class="servidor-card__label">Servidor</span>
                <h3>{{ servidor.nome }}</h3>
                <p class="servidor-card__subtle">{{ clienteNome(servidor.cliente_id) }}</p>
              </div>
              <div class="servidor-card__status">
                <span class="servidor-card__label">Status</span>
                <span
                  class="status-pill"
                  [class.status-pill--warning]="servidor.status === 2"
                  [class.status-pill--danger]="servidor.status === 3"
                  [class.status-pill--inactive]="servidor.status === 0"
                >
                  {{ statusLabel(servidor.status) }}
                </span>
              </div>
            </header>

            <div class="servidor-card__meta">
              <div>
                <span class="servidor-card__label">Endereço IP</span>
                <p>{{ servidor.endereco_ip }}</p>
              </div>
              <div>
                <span class="servidor-card__label">Sistema operacional</span>
                <p>{{ servidor.sistema_operacional || 'Não informado' }}</p>
              </div>
              <div>
                <span class="servidor-card__label">Uptime</span>
                <p>{{ servidor.uptime_inicio ? (servidor.uptime_inicio | date: 'dd/MM/yyyy HH:mm') : '—' }}</p>
              </div>
            </div>

            <div class="servidor-card__error" *ngIf="servidor.mensagem_erro; else noError">
              <span class="servidor-card__label">Último erro</span>
              <p>{{ servidor.mensagem_erro }}</p>
            </div>
            <ng-template #noError>
              <div class="servidor-card__error servidor-card__error--empty">
                <span class="servidor-card__label">Último erro</span>
                <p>Nenhum erro registrado.</p>
              </div>
            </ng-template>

            <footer class="servidor-card__actions">
              <button
                pButton
                type="button"
                class="p-button-text"
                icon="pi pi-pencil"
                label="Editar"
                (click)="startEdit(servidor)"
              ></button>
              <button
                pButton
                type="button"
                class="p-button-danger p-button-text"
                icon="pi pi-trash"
                label="Excluir"
                (click)="delete(servidor)"
              ></button>
            </footer>
          </article>
        </div>
      </ng-container>
      <ng-template #emptyState>
        <p class="empty-state">Nenhum servidor cadastrado até o momento.</p>
      </ng-template>
    </ng-container>
    <ng-template #loadingState>
      <div class="loading-state">
        <span>Carregando servidores...</span>
      </div>
    </ng-template>
  </section>

  <p-dialog
    [visible]="isFormVisible()"
    (visibleChange)="isFormVisible.set($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [contentStyle]="{ padding: '1.5rem' }"
    (onHide)="closeForm()"
    [dismissableMask]="true"
    header="{{ formMode() === 'create' ? 'Cadastrar servidor' : 'Editar servidor' }}"
  >
    <form [formGroup]="servidorForm" (ngSubmit)="submit()" class="servidor-form">
      <div class="form-row">
        <label for="cliente_id">Cliente</label>
        <p-select
          id="cliente_id"
          formControlName="cliente_id"
          [options]="clientes()"
          optionLabel="nome_empresa"
          optionValue="id"
          placeholder="Selecione um cliente"
          [showClear]="true"
        ></p-select>
        <small class="field-error" *ngIf="servidorForm.controls.cliente_id.hasError('required')">
          Selecione o cliente.
        </small>
      </div>

      <div class="form-row">
        <label for="nome">Nome do servidor</label>
        <input pInputText id="nome" formControlName="nome" placeholder="Ex: Fileserver 01" />
        <small class="field-error" *ngIf="servidorForm.controls.nome.hasError('required')">
          Informe o nome do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="endereco_ip">Endereço IP</label>
        <input pInputText id="endereco_ip" formControlName="endereco_ip" placeholder="Ex: 10.0.0.12" />
        <small class="field-error" *ngIf="servidorForm.controls.endereco_ip.hasError('required')">
          Informe o IP do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="sistema_operacional">Sistema operacional</label>
        <input
          pInputText
          id="sistema_operacional"
          formControlName="sistema_operacional"
          placeholder="Ex: Ubuntu 22.04"
        />
      </div>

      <div class="form-row">
        <label for="status">Status</label>
        <p-select
          id="status"
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o status"
        ></p-select>
      </div>

      <div class="form-row">
        <label for="uptime_inicio">Uptime (início)</label>
        <p-datepicker
          id="uptime_inicio"
          formControlName="uptime_inicio"
          [showIcon]="true"
          [showTime]="true"
          hourFormat="24"
          dateFormat="yy-mm-dd"
        ></p-datepicker>
      </div>

      <div class="form-row">
        <label for="mensagem_erro">Mensagem de erro</label>
        <textarea
          pTextarea
          id="mensagem_erro"
          formControlName="mensagem_erro"
          rows="2"
          class="textarea-control"
        ></textarea>
      </div>

      <p-divider></p-divider>

      <div class="form-actions">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="closeForm()"></button>
        <button
          pButton
          type="submit"
          [label]="formMode() === 'create' ? 'Cadastrar' : 'Salvar alterações'"
          [loading]="saving()"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
