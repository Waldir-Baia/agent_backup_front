<section class="agendamentos-page">
  <div class="page-header">
    <div>
      <h2>Agendamentos</h2>
      <p>Configure os períodos de execução do Rclone para cada cliente.</p>
    </div>

    <button pButton type="button" label="Incluir agendamento" icon="pi pi-plus" (click)="showCreateForm()"></button>
  </div>

  <section class="client-selector">
    <mat-card class="client-selector-card">
      <div class="client-selector-card__header">
        <div class="client-selector-card__icon">
          <mat-icon>groups</mat-icon>
        </div>
        <div class="client-selector-card__copy">
          <h3>Selecionar cliente</h3>
          <p>Busque pelo nome ou CNPJ para visualizar ou criar agendamentos.</p>
        </div>
      </div>

      <mat-form-field appearance="fill" class="client-selector-field">
        <mat-label>Cliente</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          [formControl]="clientFilterControl"
          [matAutocomplete]="clienteAutocomplete"
          placeholder="Digite para buscar..."
          autocomplete="off"
        />
        <button
          mat-icon-button
          matSuffix
          type="button"
          aria-label="Limpar seleção"
          *ngIf="selectedClientId() || clientFilterControl.value"
          (click)="clearClientSelection()"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete
          #clienteAutocomplete="matAutocomplete"
          [displayWith]="clientDisplayWith"
          (optionSelected)="onClientSelected($event.option.value)"
        >
          <mat-option
            *ngFor="let cliente of filteredClientes()"
            [value]="cliente.client_id"
            class="client-option"
          >
            {{ cliente.nome_empresa }} - {{ formatCnpj(cliente.cnpj_empresa) }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </mat-card>
  </section>

  <section class="agendamentos-table">
    @if (selectedClientId()) {
      @if (!loading()) {
        <div class="table-wrapper">
          <table mat-table [dataSource]="agendamentos()" class="mat-elevation-z1">
            <ng-container matColumnDef="schedule_name">
              <th mat-header-cell *matHeaderCellDef>Nome</th>
              <td mat-cell *matCellDef="let agendamento">{{ agendamento.schedule_name }}</td>
            </ng-container>

            <ng-container matColumnDef="rclone_command">
              <th mat-header-cell *matHeaderCellDef>Comando</th>
              <td mat-cell *matCellDef="let agendamento" class="command-cell">
                <code>{{ agendamento.rclone_command }}</code>
              </td>
            </ng-container>

            <ng-container matColumnDef="cron_expression">
              <th mat-header-cell *matHeaderCellDef>Cron</th>
              <td mat-cell *matCellDef="let agendamento">{{ agendamento.cron_expression }}</td>
            </ng-container>

            <ng-container matColumnDef="is_active">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let agendamento">
                <span class="status-chip" [class.active]="agendamento.is_active">
                  {{ agendamento.is_active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let agendamento">
                <button mat-icon-button aria-label="Editar" (click)="startEdit(agendamento)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  aria-label="Excluir"
                  color="warn"
                  (click)="delete(agendamento)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
          <p class="empty-state" *ngIf="agendamentos().length === 0">
            Nenhum agendamento cadastrado para este cliente.
          </p>
        </div>
      } @else {
        <div class="loading-state">
          <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
          <span>Carregando agendamentos...</span>
        </div>
      }
    } @else {
      <p class="empty-state">
        Selecione um cliente para visualizar os agendamentos.
      </p>
    }
  </section>

  <p-dialog
    [visible]="isFormVisible()"
    (visibleChange)="isFormVisible.set($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [contentStyle]="{ padding: '1.5rem' }"
    (onHide)="closeForm()"
    [dismissableMask]="true"
    header="{{ formMode() === 'create' ? 'Criar agendamento' : 'Editar agendamento' }}"
  >
    <form [formGroup]="agendamentoForm" (ngSubmit)="submit()" class="agendamento-form">
      <div class="form-row">
        <label for="form_client_id">Cliente</label>
        <p-select
          id="form_client_id"
          formControlName="client_id"
          [options]="clientes()"
          optionLabel="nome_empresa"
          optionValue="client_id"
          placeholder="Selecione um cliente"
          [showClear]="true"
        ></p-select>
        <small class="field-error" *ngIf="agendamentoForm.controls.client_id.hasError('required')">
          Informe o cliente do agendamento.
        </small>
      </div>

      <div class="form-row">
        <label for="schedule_name">Nome do agendamento</label>
        <input
          pInputText
          id="schedule_name"
          formControlName="schedule_name"
          placeholder="Backup incremental diário"
        />
        <small class="field-error" *ngIf="agendamentoForm.controls.schedule_name.hasError('required')">
          Informe o nome do agendamento.
        </small>
      </div>

      <div class="form-row">
        <label for="rclone_command">Comando Rclone</label>
        <textarea
          pTextarea
          id="rclone_command"
          formControlName="rclone_command"
          rows="4"
          placeholder="rclone sync ..."
        ></textarea>
        <small class="field-error" *ngIf="agendamentoForm.controls.rclone_command.hasError('required')">
          Informe o comando que será executado.
        </small>
      </div>

      <div class="form-row">
        <label for="cron_expression">Cron expression</label>
        <input
          pInputText
          id="cron_expression"
          formControlName="cron_expression"
          placeholder="0 2 * * *"
        />
        <small class="field-error" *ngIf="agendamentoForm.controls.cron_expression.hasError('required')">
          Informe a expressão cron.
        </small>
      </div>

      <div class="form-row">
        <label for="remote_path">Remote path (opcional)</label>
        <input
          pInputText
          id="remote_path"
          formControlName="remote_path"
          placeholder="remote:path"
        />
      </div>

      <div class="form-row inline">
        <label for="is_active">Ativo</label>
        <p-toggleSwitch formControlName="is_active"></p-toggleSwitch>
      </div>

      <p-divider></p-divider>

      <div class="form-actions">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="closeForm()"></button>
        <button
          pButton
          type="submit"
          [label]="formMode() === 'create' ? 'Criar agendamento' : 'Salvar alterações'"
          [loading]="saving()"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
