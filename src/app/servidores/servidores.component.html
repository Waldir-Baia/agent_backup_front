<section class="servidores-page">
  <div class="page-header">
    <div>
      <h2>Servidores</h2>
      <p>Cadastre e acompanhe os servidores por cliente.</p>
    </div>
    <button pButton type="button" label="Adicionar novo" icon="pi pi-plus" (click)="showCreateForm()"></button>
  </div>

  <section class="servidores-table">
    <div class="table-wrapper" *ngIf="!loading(); else loadingState">
      <table mat-table [dataSource]="servidores()" class="mat-elevation-z1">
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef>Cliente</th>
          <td mat-cell *matCellDef="let servidor">{{ clienteNome(servidor.cliente_id) }}</td>
        </ng-container>

        <ng-container matColumnDef="nome">
          <th mat-header-cell *matHeaderCellDef>Servidor</th>
          <td mat-cell *matCellDef="let servidor">{{ servidor.nome }}</td>
        </ng-container>

        <ng-container matColumnDef="endereco_ip">
          <th mat-header-cell *matHeaderCellDef>Endereço IP</th>
          <td mat-cell *matCellDef="let servidor">{{ servidor.endereco_ip }}</td>
        </ng-container>

        <ng-container matColumnDef="sistema_operacional">
          <th mat-header-cell *matHeaderCellDef>Sistema operacional</th>
          <td mat-cell *matCellDef="let servidor">
            {{ servidor.sistema_operacional || 'Não informado' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let servidor">
            <span
              class="status-pill"
              [class.status-pill--warning]="servidor.status === 2"
              [class.status-pill--danger]="servidor.status === 3"
              [class.status-pill--inactive]="servidor.status === 0"
            >
              {{ statusLabel(servidor.status) }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="uptime_inicio">
          <th mat-header-cell *matHeaderCellDef>Uptime</th>
          <td mat-cell *matCellDef="let servidor">
            {{ servidor.uptime_inicio ? (servidor.uptime_inicio | date: 'short') : '—' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let servidor">
            <button mat-icon-button aria-label="Editar" (click)="startEdit(servidor)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button aria-label="Excluir" color="warn" (click)="delete(servidor)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <p class="empty-state" *ngIf="servidores().length === 0">
        Nenhum servidor cadastrado até o momento.
      </p>
    </div>

    <ng-template #loadingState>
      <div class="loading-state">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
        <span>Carregando servidores...</span>
      </div>
    </ng-template>
  </section>

  <p-dialog
    [visible]="isFormVisible()"
    (visibleChange)="isFormVisible.set($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [contentStyle]="{ padding: '1.5rem' }"
    (onHide)="closeForm()"
    [dismissableMask]="true"
    header="{{ formMode() === 'create' ? 'Cadastrar servidor' : 'Editar servidor' }}"
  >
    <form [formGroup]="servidorForm" (ngSubmit)="submit()" class="servidor-form">
      <div class="form-row">
        <label for="cliente_id">Cliente</label>
        <p-select
          id="cliente_id"
          formControlName="cliente_id"
          [options]="clientes()"
          optionLabel="nome_empresa"
          optionValue="id"
          placeholder="Selecione um cliente"
          [showClear]="true"
        ></p-select>
        <small class="field-error" *ngIf="servidorForm.controls.cliente_id.hasError('required')">
          Selecione o cliente.
        </small>
      </div>

      <div class="form-row">
        <label for="nome">Nome do servidor</label>
        <input pInputText id="nome" formControlName="nome" placeholder="Ex: Fileserver 01" />
        <small class="field-error" *ngIf="servidorForm.controls.nome.hasError('required')">
          Informe o nome do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="endereco_ip">Endereço IP</label>
        <input pInputText id="endereco_ip" formControlName="endereco_ip" placeholder="Ex: 10.0.0.12" />
        <small class="field-error" *ngIf="servidorForm.controls.endereco_ip.hasError('required')">
          Informe o IP do servidor.
        </small>
      </div>

      <div class="form-row">
        <label for="sistema_operacional">Sistema operacional</label>
        <input
          pInputText
          id="sistema_operacional"
          formControlName="sistema_operacional"
          placeholder="Ex: Ubuntu 22.04"
        />
      </div>

      <div class="form-row">
        <label for="status">Status</label>
        <p-select
          id="status"
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o status"
        ></p-select>
      </div>

      <div class="form-row">
        <label for="uptime_inicio">Uptime (início)</label>
        <p-datepicker
          id="uptime_inicio"
          formControlName="uptime_inicio"
          [showIcon]="true"
          [showTime]="true"
          hourFormat="24"
          dateFormat="yy-mm-dd"
        ></p-datepicker>
      </div>

      <div class="form-row">
        <label for="mensagem_erro">Mensagem de erro</label>
        <textarea
          pTextarea
          id="mensagem_erro"
          formControlName="mensagem_erro"
          rows="2"
          class="textarea-control"
        ></textarea>
      </div>

      <p-divider></p-divider>

      <div class="form-actions">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="closeForm()"></button>
        <button
          pButton
          type="submit"
          [label]="formMode() === 'create' ? 'Cadastrar' : 'Salvar alterações'"
          [loading]="saving()"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
